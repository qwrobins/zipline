# Story 3.2: Add New Comment (Optimistic UI)

## Status
Approved

## Story
**As a** user,
**I want** to add my own comment to a post,
**so that** I can participate in the discussion.

## Acceptance Criteria
1. Comment form displayed below existing comments with Name, Email, and Comment body fields
2. Form validation using Zod schema (name and email required, valid email format, body min length)
3. Submit button triggers optimistic insert: new comment immediately appears in list
4. Success toast notification displayed ("Comment added!")
5. Form clears after successful submission
6. Mock POST request sent to `/posts/{postId}/comments` with form data
7. Comment count badge increments immediately
8. New comment assigned temporary ID and added to top or bottom of list
9. Loading/submitting state shown on submit button during request
10. Error handling: if mock POST fails, rollback optimistic update and show error toast

## Tasks / Subtasks
- [ ] Create comment form validation schema (AC: 2)
  - [ ] Define Zod schema in /lib/utils/validators.ts or /lib/api/schemas.ts
  - [ ] Include name (required, min length), email (required, valid format), body (required, min length)
  - [ ] Export CommentFormData type
- [ ] Create API service for creating comment (AC: 6)
  - [ ] Add createComment function to /lib/api/comments.ts
  - [ ] Accept postId and CommentFormData parameters
  - [ ] Send POST request to `/posts/{postId}/comments`
  - [ ] Return created comment with server-generated ID
- [ ] Create React Query mutation hook with optimistic update (AC: 3, 7, 8, 10)
  - [ ] Create useCreateComment hook in /lib/hooks/use-comments.ts
  - [ ] Implement useMutation with optimistic update logic
  - [ ] Generate temporary ID (negative number or UUID) for new comment
  - [ ] Update React Query cache immediately with optimistic comment
  - [ ] Implement onError rollback to restore previous cache state
  - [ ] Invalidate comments query on success to sync with server
- [ ] Create CommentForm component (AC: 1, 2, 5, 9)
  - [ ] Create /components/comments/comment-form.tsx
  - [ ] Use React Hook Form for form state management
  - [ ] Integrate Zod schema validation with React Hook Form
  - [ ] Create fields for name, email, and comment body
  - [ ] Show validation errors inline below each field
  - [ ] Display loading state on submit button during mutation
  - [ ] Clear form fields after successful submission
  - [ ] Use shadcn/ui Input, Textarea, Button components
- [ ] Integrate toast notifications (AC: 4, 10)
  - [ ] Use Sonner for toast notifications
  - [ ] Show success toast on successful comment creation
  - [ ] Show error toast on mutation failure with rollback
  - [ ] Ensure toast messages are user-friendly
- [ ] Update CommentList to handle optimistic updates (AC: 3, 7, 8)
  - [ ] Ensure CommentList re-renders when cache updates
  - [ ] Display new comment immediately at top or bottom of list
  - [ ] Update comment count badge to reflect new comment
  - [ ] Handle temporary IDs in comment rendering
- [ ] Integrate CommentForm into post detail page (AC: 1)
  - [ ] Add CommentForm component below CommentList in /app/posts/[id]/page.tsx
  - [ ] Pass postId prop to CommentForm
  - [ ] Ensure proper spacing and layout

## Dev Notes

### Form Validation with Zod
[Source: docs/architecture/tech-stack.md]

**Validation Technology:** Zod v3.x for runtime type validation

**Form Validation Schema:**
```typescript
// lib/utils/validators.ts or lib/api/schemas.ts
import { z } from 'zod';

export const commentFormSchema = z.object({
  name: z.string().min(3, 'Name must be at least 3 characters'),
  email: z.string().email('Invalid email address'),
  body: z.string().min(10, 'Comment must be at least 10 characters'),
});

export type CommentFormData = z.infer<typeof commentFormSchema>;
```

### React Hook Form Integration
[Source: docs/architecture/tech-stack.md]

**Form Management:** React Hook Form v7.x for performant form state management

**Form Setup Pattern:**
```typescript
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { commentFormSchema, CommentFormData } from '@/lib/utils/validators';

const form = useForm<CommentFormData>({
  resolver: zodResolver(commentFormSchema),
  defaultValues: {
    name: '',
    email: '',
    body: '',
  },
});
```

### API Service for Creating Comments
[Source: docs/architecture/components.md]

**Service Function:**
```typescript
// lib/api/comments.ts
export async function createComment(
  postId: number,
  data: CommentFormData
): Promise<Comment> {
  return apiFetch(`/posts/${postId}/comments`, {
    method: 'POST',
    body: JSON.stringify(data),
  }, commentSchema);
}
```

### Optimistic Updates with React Query
[Source: docs/architecture/coding-standards.md]

**Critical Rule:** All mutations must implement optimistic updates with rollback logic

**Optimistic Update Pattern:**
```typescript
// lib/hooks/use-comments.ts
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { createComment } from '@/lib/api/comments';
import { queryKeys } from '@/lib/api/query-keys';
import type { Comment, CommentFormData } from '@/types';

export function useCreateComment(postId: number) {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (data: CommentFormData) => createComment(postId, data),

    // Optimistic update: immediately add comment to cache
    onMutate: async (newComment) => {
      // Cancel outgoing refetches
      await queryClient.cancelQueries({
        queryKey: queryKeys.comments.list(postId),
      });

      // Snapshot previous value
      const previousComments = queryClient.getQueryData<Comment[]>(
        queryKeys.comments.list(postId)
      );

      // Optimistically update cache
      queryClient.setQueryData<Comment[]>(
        queryKeys.comments.list(postId),
        (old = []) => [
          ...old,
          {
            id: Date.now() * -1, // Temporary negative ID
            postId,
            name: newComment.name,
            email: newComment.email,
            body: newComment.body,
          },
        ]
      );

      // Return context with snapshot
      return { previousComments };
    },

    // Rollback on error
    onError: (err, newComment, context) => {
      if (context?.previousComments) {
        queryClient.setQueryData(
          queryKeys.comments.list(postId),
          context.previousComments
        );
      }
    },

    // Always refetch after error or success
    onSettled: () => {
      queryClient.invalidateQueries({
        queryKey: queryKeys.comments.list(postId),
      });
    },
  });
}
```

### Immutable State Updates
[Source: docs/architecture/coding-standards.md]

**Critical Rule:** Never mutate React Query cache directly; use setQueryData with immutable updates

**Correct Pattern:**
```typescript
// Correct: Immutable update
queryClient.setQueryData<Comment[]>(
  queryKeys.comments.list(postId),
  (old = []) => [...old, newComment]
);

// Incorrect: Mutating cache directly
// const comments = queryClient.getQueryData(key);
// comments.push(newComment); // NEVER DO THIS
```

### Toast Notifications
[Source: docs/architecture/tech-stack.md]

**Notification System:** Sonner for accessible toast notifications

**Toast Usage:**
```typescript
import { toast } from 'sonner';

// Success toast
toast.success('Comment added!');

// Error toast
toast.error('Failed to add comment. Please try again.');
```

### Component Structure
[Source: docs/architecture/unified-project-structure.md]

**Component File:**
```
components/
└── comments/
    ├── comment-list.tsx      # Already created in Story 3.1
    ├── comment-item.tsx      # Already created in Story 3.1
    ├── comment-form.tsx      # Create in this story
    └── comment-actions.tsx   # Will be created in Story 3.3
```

### Form Component Template
[Source: docs/architecture/frontend-architecture.md]

```typescript
'use client';

import { FC } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { useCreateComment } from '@/lib/hooks/use-comments';
import { commentFormSchema, CommentFormData } from '@/lib/utils/validators';
import { toast } from 'sonner';

interface CommentFormProps {
  postId: number;
}

export const CommentForm: FC<CommentFormProps> = ({ postId }) => {
  const { mutate, isPending } = useCreateComment(postId);

  const form = useForm<CommentFormData>({
    resolver: zodResolver(commentFormSchema),
    defaultValues: { name: '', email: '', body: '' },
  });

  const onSubmit = (data: CommentFormData) => {
    mutate(data, {
      onSuccess: () => {
        toast.success('Comment added!');
        form.reset();
      },
      onError: () => {
        toast.error('Failed to add comment. Please try again.');
      },
    });
  };

  return (
    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
      <Input
        {...form.register('name')}
        placeholder="Your name"
        disabled={isPending}
      />
      {form.formState.errors.name && (
        <p className="text-sm text-red-500">{form.formState.errors.name.message}</p>
      )}

      <Input
        {...form.register('email')}
        type="email"
        placeholder="Your email"
        disabled={isPending}
      />
      {form.formState.errors.email && (
        <p className="text-sm text-red-500">{form.formState.errors.email.message}</p>
      )}

      <Textarea
        {...form.register('body')}
        placeholder="Write your comment..."
        disabled={isPending}
      />
      {form.formState.errors.body && (
        <p className="text-sm text-red-500">{form.formState.errors.body.message}</p>
      )}

      <Button type="submit" disabled={isPending}>
        {isPending ? 'Submitting...' : 'Submit Comment'}
      </Button>
    </form>
  );
};
```

### shadcn/ui Components to Use
[Source: docs/architecture/components.md]

- `Input` for name and email fields
- `Textarea` for comment body field
- `Button` for submit button
- `Label` for form field labels (optional)

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Critical Rules:**
- **Form Validation:** Use React Hook Form + Zod for all forms; no uncontrolled inputs
- **Optimistic Updates:** All mutations must implement optimistic updates with rollback logic
- **Query Key Consistency:** Always use centralized queryKeys object; never hardcode strings
- **Immutable State:** Never mutate React Query cache directly; use setQueryData with immutable updates
- **Error Handling:** Catch and display user-friendly errors; use toast notifications for feedback

**Naming Conventions:**
- Components: PascalCase (`CommentForm.tsx`)
- Hooks: camelCase with 'use' prefix (`useCreateComment.ts`)
- Types/Interfaces: PascalCase (`CommentFormData`)

### Temporary ID Generation
[Source: docs/architecture/frontend-architecture.md]

**Temporary IDs for Optimistic Creates:**
- Use negative numbers: `Date.now() * -1`
- Or use UUIDs: `crypto.randomUUID()`
- Ensure temporary IDs are unique and distinguishable from server IDs

### React Query Configuration
[Source: docs/architecture/frontend-architecture.md]

**Mutation Configuration:**
```typescript
export const queryClient = new QueryClient({
  defaultOptions: {
    mutations: {
      retry: 1,
    },
  },
});
```

### Testing
[Source: docs/architecture/testing-strategy.md]

**Unit Tests Required:**
- `tests/unit/components/comments/comment-form.test.tsx`
  - Renders form fields correctly
  - Shows validation errors for invalid input
  - Disables form during submission
  - Clears form after successful submission
  - Displays loading state on submit button

**Integration Tests Required:**
- `tests/integration/comment-crud.test.tsx`
  - Creates comment with optimistic UI update
  - Shows success toast after submission
  - Rolls back optimistic update on error
  - Shows error toast on failure
  - Comment appears immediately in list
  - Comment count increments immediately

**E2E Tests Required:**
- `tests/e2e/comments/create-comment.spec.ts`
  - Navigate to post detail page
  - Fill out comment form with valid data
  - Submit form and verify optimistic update
  - Verify comment appears in list immediately
  - Verify success toast displays
  - Verify form clears after submission
  - Test validation errors for invalid input
  - Test error handling for API failure

**Integration Test Example:**
```typescript
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { rest } from 'msw';
import { setupServer } from 'msw/node';
import { CommentForm } from '@/components/comments/comment-form';

const server = setupServer(
  rest.post('https://jsonplaceholder.typicode.com/posts/1/comments', (req, res, ctx) => {
    return res(
      ctx.status(201),
      ctx.json({ id: 501, postId: 1, name: 'Test User', email: 'test@example.com', body: 'Test comment' })
    );
  })
);

beforeAll(() => server.listen());
afterEach(() => server.resetHandlers());
afterAll(() => server.close());

describe('CommentForm Optimistic Update', () => {
  it('creates comment with optimistic UI', async () => {
    const user = userEvent.setup();
    const queryClient = new QueryClient();

    render(
      <QueryClientProvider client={queryClient}>
        <CommentForm postId={1} />
      </QueryClientProvider>
    );

    await user.type(screen.getByPlaceholderText(/name/i), 'Test User');
    await user.type(screen.getByPlaceholderText(/email/i), 'test@example.com');
    await user.type(screen.getByPlaceholderText(/comment/i), 'Test comment');
    await user.click(screen.getByRole('button', { name: /submit/i }));

    // Verify optimistic update (comment appears immediately)
    expect(await screen.findByText('Test comment')).toBeInTheDocument();

    // Verify success toast
    await waitFor(() => {
      expect(screen.getByText(/comment added/i)).toBeInTheDocument();
    });
  });
});
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_