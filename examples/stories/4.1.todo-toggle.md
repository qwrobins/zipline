# Story 4.1: Todo Toggle Completion (Optimistic UI)

## Status
Approved

## Story
**As a** user,
**I want** to mark todos as complete or incomplete with a single click,
**so that** I can track progress on tasks.

## Acceptance Criteria
1. Checkbox displayed next to each todo item on user profile Todos tab
2. Clicking checkbox toggles completion state immediately (optimistic update)
3. Completed todos visually distinguished: strikethrough text, muted color, checked checkbox
4. Mock PATCH request sent to `/todos/{id}` with updated `completed` status
5. Success toast notification optional (may be too noisy for toggle action)
6. Error handling: if mock PATCH fails, rollback toggle and show error toast
7. Todo count summary updates immediately (e.g., "8/20 completed")
8. Toggle animation smooth (checkbox transition, text styling change)

## Tasks / Subtasks
- [ ] Create TodoItem component with checkbox UI (AC: 1, 3)
  - [ ] Import shadcn/ui Checkbox component
  - [ ] Render todo title with checkbox
  - [ ] Apply conditional styling for completed state (strikethrough, muted colors)
  - [ ] Add smooth transition CSS for checkbox and text changes
- [ ] Implement useUpdateTodo mutation hook (AC: 2, 4, 6)
  - [ ] Create mutation function in lib/api/todos.ts for PATCH /todos/{id}
  - [ ] Implement React Query mutation with optimistic update
  - [ ] Configure onMutate to update cache immediately before API call
  - [ ] Configure onError to rollback cache on failure
  - [ ] Configure onSettled to refetch todos after mutation completes
- [ ] Add error handling and toast notifications (AC: 5, 6)
  - [ ] Show error toast on mutation failure using Sonner
  - [ ] Include rollback logic in onError callback
  - [ ] Optionally add success toast (consider UX noise)
- [ ] Create todo count summary component (AC: 7)
  - [ ] Calculate completed vs total todos from query data
  - [ ] Display "X/Y completed" text
  - [ ] Update count immediately on optimistic update
- [ ] Integrate TodoItem into user profile Todos tab (AC: 1-8)
  - [ ] Add TodoItem to TodoList component
  - [ ] Pass todo data and mutation handlers to TodoItem
  - [ ] Verify toggle works in user profile context

## Dev Notes

### Todo Data Model
[Source: docs/architecture/data-models.md]

The Todo interface defines the structure for task items:

```typescript
interface Todo {
  id: number;
  userId: number;
  title: string;
  completed: boolean;
}
```

**Key Attributes:**
- `id`: Unique todo identifier
- `userId`: Foreign key to assigned user (many-to-one relationship)
- `title`: Task description
- `completed`: Boolean completion status (toggle target)

### React Query Mutation Pattern with Optimistic Updates
[Source: docs/architecture/components.md]

The mutation hooks must implement optimistic updates:

```typescript
useUpdateTodo(): Mutation hook with optimistic update
```

**Implementation Pattern:**
- Update cache immediately in `onMutate` before API call
- Store previous state in context for rollback
- Rollback cache in `onError` if API fails
- Refetch or revalidate in `onSettled` for consistency

[Source: docs/architecture/frontend-architecture.md]

**Optimistic Update Requirements:**
- **Temporary State:** Update cache immediately before API confirmation
- **Rollback on Failure:** Automatic cache rollback if API returns error
- **Query Key Hierarchy:** Use centralized queryKeys for cache invalidation

**Query Keys Structure:**
```typescript
export const queryKeys = {
  todos: {
    all: ['todos'] as const,
    lists: () => [...queryKeys.todos.all, 'list'] as const,
    list: (filters: TodoFilters) => [...queryKeys.todos.lists(), filters] as const,
  },
} as const;
```

### API Service Layer
[Source: docs/architecture/components.md]

API service function to implement in `lib/api/todos.ts`:

```typescript
updateTodo(id: number, data: Partial<Todo>): Mock update todo
```

- Method: PATCH
- Endpoint: `/todos/{id}`
- Body: `{ completed: boolean }`
- Mock response: Return updated todo object

[Source: docs/architecture/frontend-architecture.md]

**API Client Pattern:**
```typescript
async function apiFetch<T>(
  endpoint: string,
  options?: RequestInit,
  schema?: z.ZodSchema<T>
): Promise<T>
```

- Must validate response with Zod schema
- Throw APIError on failure
- Include proper Content-Type headers

### Form Validation with Zod
[Source: docs/architecture/coding-standards.md]

- **Form Validation:** Use React Hook Form + Zod for all forms; no uncontrolled inputs

Note: This story primarily uses checkbox toggle, not a full form. However, if building a future edit form, follow React Hook Form + Zod pattern.

### Component Architecture
[Source: docs/architecture/frontend-architecture.md]

**Component Location:**
```
components/todos/
├── todo-item.tsx       # Individual todo with checkbox (CREATE THIS)
└── todo-list.tsx       # List of todos (UPDATE THIS)
```

**shadcn/ui Components to Use:**
- Checkbox component for toggle
- Card/Badge for todo item styling
- Optional: Toast for notifications

### Visual Styling for Completed Todos
[Source: Story AC 3]

Completed todos require visual distinction:
- **Strikethrough text:** Apply `line-through` decoration to title
- **Muted color:** Use `text-muted-foreground` Tailwind class
- **Checked checkbox:** Checkbox component handles checked state
- **Smooth animation:** Add CSS transitions for state changes

**Example Tailwind Classes:**
```typescript
className={cn(
  'transition-all duration-200',
  todo.completed && 'line-through text-muted-foreground'
)}
```

### Error Handling
[Source: docs/architecture/coding-standards.md]

- **Error Handling:** Catch and display user-friendly errors; use toast notifications for feedback
- **Optimistic Updates:** All mutations must implement optimistic updates with rollback logic

**Implementation:**
- Show error toast using Sonner on mutation failure
- Rollback cache to previous state in `onError` callback
- Display user-friendly error message (not raw API error)

### Toast Notifications
[Source: docs/architecture/tech-stack.md]

**Notifications:** Sonner toast notification system (PRD requirement NFR11)
- Accessible announcements
- Minimal setup required

**Usage:**
```typescript
import { toast } from 'sonner';

// Error notification
toast.error('Failed to update todo');

// Optional success notification (consider UX noise for toggle)
toast.success('Todo updated');
```

### Testing
[Source: docs/architecture/testing-strategy.md]

**Unit Tests Required:**
- `tests/unit/components/todos/todo-item.test.tsx`
  - Renders todo with checkbox
  - Applies completed styling when todo.completed is true
  - Calls mutation handler when checkbox clicked
  - Shows error toast on mutation failure

**Integration Tests Required:**
- `tests/integration/todo-management.test.tsx`
  - Toggles todo completion with optimistic UI
  - Verifies immediate cache update
  - Verifies rollback on API failure

**E2E Tests Required:**
- `tests/e2e/todos/toggle-todo.spec.ts`
  - User can check/uncheck todo checkbox
  - Completed todos show strikethrough styling
  - Todo count updates immediately
  - Error message shown if toggle fails

**Testing Pattern:**
```typescript
import { render, screen, waitFor } from '@testing-library/react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { rest } from 'msw';
import { setupServer } from 'msw/node';
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_