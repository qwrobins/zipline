# Story 3.5: Comment Count Badges on Feed

## Status
Approved

## Story
**As a** user,
**I want** to see comment counts on post cards in the feed,
**so that** I can identify popular or active discussions.

## Acceptance Criteria
1. Comment count badge displayed on each post card in feed (e.g., "ðŸ’¬ 12" or icon with number)
2. Badge uses shadcn/ui Badge component with appropriate styling
3. Comment counts fetched efficiently (consider `/posts` with comments count or separate query)
4. Badge is clickable and navigates to post detail page, scrolling to comments section
5. Zero comments shown as "0" or hidden badge (design decision)
6. Badge updates optimistically when user adds/deletes comment from post detail page
7. Loading state: show badge with "..." or skeleton if count not yet loaded

## Tasks / Subtasks
- [ ] Design comment count badge component (AC: 1, 2)
  - [ ] Create CommentCountBadge component using shadcn/ui Badge
  - [ ] Add MessageCircle icon from lucide-react
  - [ ] Style badge with appropriate variant (secondary or outline)
  - [ ] Format count with proper number formatting (e.g., "999+" for large numbers)
  - [ ] Make badge visually distinct but not overwhelming
- [ ] Implement efficient comment count fetching (AC: 3)
  - [ ] Evaluate option 1: Fetch all comments and count client-side
  - [ ] Evaluate option 2: Store counts in React Query cache from post detail visits
  - [ ] Evaluate option 3: Create derived query that aggregates counts
  - [ ] Choose most efficient approach for JSONPlaceholder API constraints
  - [ ] Document decision and performance implications
- [ ] Integrate badge into PostCard component (AC: 1)
  - [ ] Add CommentCountBadge to post-card.tsx
  - [ ] Position badge in footer or metadata section
  - [ ] Ensure responsive layout on mobile
  - [ ] Add proper spacing and alignment
- [ ] Implement clickable badge navigation (AC: 4)
  - [ ] Make badge clickable with button/link behavior
  - [ ] Navigate to `/posts/{id}` on click
  - [ ] Scroll to comments section using hash fragment or programmatic scroll
  - [ ] Add smooth scroll behavior
  - [ ] Ensure keyboard accessibility
- [ ] Handle zero comment state (AC: 5)
  - [ ] Decide: show "0" or hide badge entirely
  - [ ] Implement chosen design consistently
  - [ ] Consider showing "Be the first to comment" on hover
  - [ ] Document UX decision rationale
- [ ] Implement optimistic updates (AC: 6)
  - [ ] Increment count when comment added on post detail page
  - [ ] Decrement count when comment deleted on post detail page
  - [ ] Update cached count in post list query
  - [ ] Ensure updates propagate to feed without refetch
  - [ ] Handle edge cases (multiple tabs, concurrent updates)
- [ ] Add loading state (AC: 7)
  - [ ] Show skeleton or "..." while count is loading
  - [ ] Use Skeleton component from shadcn/ui
  - [ ] Ensure consistent badge size during loading
  - [ ] Handle loading state gracefully

## Dev Notes

### Comment Count Strategy
[Source: docs/architecture/data-models.md, docs/architecture/components.md]

JSONPlaceholder API provides:
- `/posts` - Returns all posts WITHOUT comment counts
- `/posts/{id}/comments` - Returns all comments for a post
- `/comments?postId={id}` - Returns all comments for a post

**Recommended Approach:**
Since JSONPlaceholder doesn't provide comment counts directly, implement client-side aggregation:

1. **Initial Load:** Post cards show skeleton/placeholder
2. **On Demand:** Fetch comment counts for visible posts only (lazy loading)
3. **Cache Strategy:** Store counts in separate query cache with long stale time
4. **Optimistic Updates:** Update counts immediately when user adds/deletes comments

```typescript
// lib/hooks/use-comments.ts
export function useCommentCount(postId: number) {
  return useQuery({
    queryKey: queryKeys.comments.count(postId),
    queryFn: async () => {
      const comments = await fetchComments(postId);
      return comments.length;
    },
    staleTime: 10 * 60 * 1000, // 10 minutes
    enabled: !!postId,
  });
}
```

### Query Key Structure
[Source: docs/architecture/frontend-architecture.md]

Extend comment query keys:
```typescript
queryKeys.comments = {
  all: ['comments'] as const,
  lists: () => [...queryKeys.comments.all, 'list'] as const,
  list: (postId: number) => [...queryKeys.comments.lists(), postId] as const,
  counts: () => [...queryKeys.comments.all, 'count'] as const,
  count: (postId: number) => [...queryKeys.comments.counts(), postId] as const,
}
```

### Badge Component
[Source: docs/architecture/components.md]

Use shadcn/ui Badge component:
```typescript
import { Badge } from '@/components/ui/badge';
import { MessageCircle } from 'lucide-react';

interface CommentCountBadgeProps {
  count: number | undefined;
  postId: number;
  isLoading?: boolean;
}

export const CommentCountBadge: FC<CommentCountBadgeProps> = ({
  count,
  postId,
  isLoading
}) => {
  const router = useRouter();

  if (isLoading) {
    return (
      <Badge variant="outline" className="gap-1">
        <MessageCircle className="h-3 w-3" />
        <span>...</span>
      </Badge>
    );
  }

  // Handle zero comments - decision point
  if (count === 0) {
    return null; // or show "0"
  }

  return (
    <Badge
      variant="secondary"
      className="gap-1 cursor-pointer hover:bg-secondary/80"
      onClick={(e) => {
        e.stopPropagation(); // Prevent card click
        router.push(`/posts/${postId}#comments`);
      }}
    >
      <MessageCircle className="h-3 w-3" />
      <span>{count}</span>
    </Badge>
  );
};
```

### Optimistic Count Updates
[Source: docs/architecture/coding-standards.md]

When comment is added/deleted, update count cache:
```typescript
// In useCreateComment mutation
onMutate: async () => {
  // ... existing optimistic update logic

  // Update count
  queryClient.setQueryData(
    queryKeys.comments.count(postId),
    (oldCount: number = 0) => oldCount + 1
  );
}

// In useDeleteComment mutation
onMutate: async () => {
  // ... existing optimistic update logic

  // Update count
  queryClient.setQueryData(
    queryKeys.comments.count(postId),
    (oldCount: number = 0) => Math.max(0, oldCount - 1)
  );
}
```

### Navigation and Scrolling
[Source: docs/architecture/frontend-architecture.md]

Use Next.js router for navigation with hash fragment:
```typescript
import { useRouter } from 'next/navigation';

const handleBadgeClick = (e: React.MouseEvent) => {
  e.stopPropagation(); // Prevent triggering parent card click
  router.push(`/posts/${postId}#comments`);
};
```

On post detail page, scroll to comments section:
```typescript
// app/posts/[id]/page.tsx
useEffect(() => {
  if (window.location.hash === '#comments') {
    const commentsSection = document.getElementById('comments');
    commentsSection?.scrollIntoView({ behavior: 'smooth' });
  }
}, []);
```

### Component Organization
[Source: docs/architecture/unified-project-structure.md]

Files to create/modify:
- `components/comments/comment-count-badge.tsx` - New badge component
- `components/posts/post-card.tsx` - Add badge to card
- `lib/hooks/use-comments.ts` - Add useCommentCount hook
- `app/posts/[id]/page.tsx` - Add scroll-to-comments functionality

### Accessibility
[Source: docs/architecture/coding-standards.md]

- Badge MUST have proper ARIA label: `aria-label="12 comments"`
- Badge MUST be keyboard navigable (button or link)
- Badge MUST have focus indicator
- Screen reader should announce: "12 comments, button"

### Performance Optimization
[Source: docs/architecture/frontend-architecture.md]

**Lazy Loading:** Only fetch comment counts for posts in viewport
```typescript
// Use Intersection Observer for lazy loading
export function useCommentCountInView(postId: number, inView: boolean) {
  return useQuery({
    queryKey: queryKeys.comments.count(postId),
    queryFn: async () => {
      const comments = await fetchComments(postId);
      return comments.length;
    },
    enabled: inView, // Only fetch when in viewport
    staleTime: 10 * 60 * 1000,
  });
}
```

**Batch Fetching:** If performance is an issue, consider fetching counts in batches
```typescript
// Fetch counts for multiple posts at once
export function useCommentCounts(postIds: number[]) {
  return useQuery({
    queryKey: [...queryKeys.comments.counts(), postIds],
    queryFn: async () => {
      const counts = await Promise.all(
        postIds.map(async (id) => {
          const comments = await fetchComments(id);
          return { postId: id, count: comments.length };
        })
      );
      return counts;
    },
  });
}
```

### React Query Configuration
[Source: docs/architecture/frontend-architecture.md]

Comment count queries should have:
- `staleTime`: 10 minutes (counts don't change frequently)
- `cacheTime`: 15 minutes
- `refetchOnWindowFocus`: false (prevent unnecessary refetches)

### Zero Comments UX Decision
Decision point for AC 5:
- **Option A:** Show "0" - Clear indication no comments exist, encourages engagement
- **Option B:** Hide badge - Cleaner UI, less visual clutter
- **Recommendation:** Show "0" for consistency and to encourage first comment

### Testing
[Source: docs/architecture/testing-strategy.md]

**Unit Tests Required:**
- Test CommentCountBadge component rendering
- Test loading state display
- Test zero count handling
- Test number formatting

**Integration Tests Required:**
- Test comment count fetching
- Test optimistic updates on comment add/delete
- Test badge click navigation
- Test scroll-to-comments functionality

**E2E Tests Required:**
```typescript
// tests/e2e/comments/comment-count-badges.spec.ts
test('displays comment count badges on feed', async ({ page }) => {
  await page.goto('/');

  // Wait for posts to load
  await expect(page.locator('[data-testid="post-card"]').first()).toBeVisible();

  // Verify badges are displayed
  const badges = page.locator('[data-testid="comment-count-badge"]');
  await expect(badges.first()).toBeVisible();

  // Verify badge has icon and count
  await expect(badges.first().locator('svg')).toBeVisible();
  await expect(badges.first().locator('text=/\\d+/')).toBeVisible();
});

test('clicking badge navigates to comments section', async ({ page }) => {
  await page.goto('/');

  // Click first post's comment badge
  await page.click('[data-testid="post-card"]:first-child [data-testid="comment-count-badge"]');

  // Verify navigation to post detail
  await expect(page).toHaveURL(/\/posts\/\d+/);

  // Verify scroll to comments section
  const commentsSection = page.locator('#comments');
  await expect(commentsSection).toBeInViewport();
});

test('badge updates optimistically on comment creation', async ({ page }) => {
  await page.goto('/');

  // Get initial count
  const badge = page.locator('[data-testid="post-card"]:first-child [data-testid="comment-count-badge"]');
  const initialCount = await badge.locator('text=/\\d+/').textContent();

  // Navigate to post detail
  await page.click('[data-testid="post-card"]:first-child');

  // Add comment
  await page.fill('input[name="name"]', 'Test User');
  await page.fill('input[name="email"]', 'test@example.com');
  await page.fill('textarea[name="body"]', 'Test comment');
  await page.click('button[type="submit"]');

  // Go back to feed
  await page.goBack();

  // Verify count incremented
  const newCount = await badge.locator('text=/\\d+/').textContent();
  expect(Number(newCount)).toBe(Number(initialCount) + 1);
});
```

### Styling
Use shadcn/ui components:
- Badge component (secondary variant)
- Skeleton component for loading state
- MessageCircle icon from lucide-react

Tailwind classes for hover/focus states:
```typescript
className="gap-1 cursor-pointer hover:bg-secondary/80 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_