# Story 4.5: Global Todos View

## Status
Approved

## Story
**As a** user,
**I want** to see all todos from all users in one consolidated view,
**so that** I can get an overview of all tasks in the system.

## Acceptance Criteria
1. Global todos page created at `/todos` route
2. All todos displayed in a list with user identification (avatar, name next to each todo)
3. Each todo item shows: checkbox, title, completion status, assigned user (clickable link to profile)
4. Filter controls available (All, Open, Completed) same as user profile view
5. Search input allows filtering by todo title text
6. Pagination implemented if todo count exceeds 20 items per page
7. Loading skeletons shown while todos are being fetched
8. Empty state displayed if no todos exist
9. All interactive features functional: toggle completion, reassign, create new todo
10. User links in todo items navigate to respective user profiles

## Tasks / Subtasks
- [ ] Create global todos page (AC: 1)
  - [ ] Create app/todos/page.tsx
  - [ ] Create app/todos/loading.tsx with skeleton UI
  - [ ] Add route to navigation component
- [ ] Implement todos list with user identification (AC: 2, 3, 10)
  - [ ] Update TodoItem component to show user avatar and name
  - [ ] Add Link component to user name for profile navigation
  - [ ] Display checkbox, title, completion status for each todo
  - [ ] Use useUsers() to hydrate user data for each todo
- [ ] Add filter controls (AC: 4)
  - [ ] Reuse or update TodoFilters component from user profile view
  - [ ] Implement filter options: All, Open, Completed
  - [ ] Sync filter state with URL query parameter (?status=completed)
  - [ ] Update useTodos hook to accept status filter
- [ ] Implement search functionality (AC: 5)
  - [ ] Add SearchInput component to page
  - [ ] Implement client-side search filtering by title
  - [ ] Debounce search input for performance
  - [ ] Update displayed todos based on search query
  - [ ] Sync search state with URL query parameter (?q=search)
- [ ] Add pagination (AC: 6)
  - [ ] Implement pagination logic for 20 items per page
  - [ ] Add Pagination component to page
  - [ ] Update useTodos to support pagination parameters
  - [ ] Sync page state with URL query parameter (?page=2)
  - [ ] Handle edge cases (empty pages, last page)
- [ ] Create loading states (AC: 7)
  - [ ] Create loading.tsx with TodoList skeleton
  - [ ] Use Skeleton component from shadcn/ui
  - [ ] Show 20 skeleton items during initial load
- [ ] Add empty state (AC: 8)
  - [ ] Create EmptyState component or inline UI
  - [ ] Display when no todos match filters
  - [ ] Show appropriate message based on context (no todos vs no search results)
- [ ] Integrate interactive features (AC: 9)
  - [ ] Ensure toggle completion works (from Story 4.1)
  - [ ] Ensure reassign works (from Story 4.4)
  - [ ] Add "Create Todo" form or button
  - [ ] Test all mutations update cache correctly
- [ ] Test global todos view
  - [ ] Test all filters work correctly
  - [ ] Test search functionality
  - [ ] Test pagination
  - [ ] Test user links navigate to profiles
  - [ ] Test all interactive features (toggle, reassign, create)
  - [ ] Test loading and empty states
  - [ ] Test accessibility (keyboard navigation, screen readers)

## Dev Notes

### Data Models
[Source: docs/architecture/data-models.md]

**Todo Interface:**
```typescript
interface Todo {
  id: number;
  userId: number;
  title: string;
  completed: boolean;
}
```

**User Interface:**
```typescript
interface User {
  id: number;
  name: string;
  username: string;
  email: string;
  address: {
    street: string;
    suite: string;
    city: string;
    zipcode: string;
    geo: {
      lat: string;
      lng: string;
    };
  };
  phone: string;
  website: string;
  company: {
    name: string;
    catchPhrase: string;
    bs: string;
  };
}
```

**Relationships:**
- Many-to-one: Todo.userId → User.id

### API Service Layer
[Source: docs/architecture/components.md, docs/architecture/frontend-architecture.md]

**Existing API Function (lib/api/todos.ts):**
```typescript
export async function fetchTodos(userId?: number): Promise<Todo[]> {
  const searchParams = new URLSearchParams();
  if (userId) searchParams.set('userId', userId.toString());

  const query = searchParams.toString();
  const endpoint = `/todos${query ? `?${query}` : ''}`;

  return apiFetch(endpoint, undefined, todoArraySchema);
}
```

**API Endpoint:**
- `GET /todos` - Fetches all todos (no userId filter)
- Returns array of Todo objects

### React Query Hook
[Source: docs/architecture/components.md, docs/architecture/frontend-architecture.md]

**Hook to Update (lib/hooks/use-todos.ts):**
```typescript
interface TodoFilters {
  userId?: number;
  status?: 'all' | 'open' | 'completed';
  page?: number;
  search?: string;
}

export function useTodos(filters?: TodoFilters) {
  return useQuery({
    queryKey: queryKeys.todos.list(filters || {}),
    queryFn: () => fetchTodos(filters?.userId),
    select: (data) => {
      let filtered = data;

      // Filter by status
      if (filters?.status === 'open') {
        filtered = filtered.filter(todo => !todo.completed);
      } else if (filters?.status === 'completed') {
        filtered = filtered.filter(todo => todo.completed);
      }

      // Filter by search query
      if (filters?.search) {
        filtered = filtered.filter(todo =>
          todo.title.toLowerCase().includes(filters.search!.toLowerCase())
        );
      }

      // Pagination
      const pageSize = 20;
      const page = filters?.page || 1;
      const start = (page - 1) * pageSize;
      const end = start + pageSize;

      return {
        todos: filtered.slice(start, end),
        totalCount: filtered.length,
        pageCount: Math.ceil(filtered.length / pageSize),
      };
    },
  });
}
```

**Users Hook (lib/hooks/use-users.ts):**
```typescript
export function useUsers() {
  return useQuery({
    queryKey: queryKeys.users.list(),
    queryFn: fetchUsers,
    staleTime: 5 * 60 * 1000, // Users don't change often
  });
}
```

### Query Keys
[Source: docs/architecture/frontend-architecture.md]

**Centralized Query Keys:**
```typescript
export const queryKeys = {
  todos: {
    all: ['todos'] as const,
    lists: () => [...queryKeys.todos.all, 'list'] as const,
    list: (filters: TodoFilters) => [...queryKeys.todos.lists(), filters] as const,
  },
  users: {
    all: ['users'] as const,
    lists: () => [...queryKeys.users.all, 'list'] as const,
    list: () => [...queryKeys.users.lists()] as const,
    details: () => [...queryKeys.users.all, 'detail'] as const,
    detail: (id: number) => [...queryKeys.users.details(), id] as const,
  },
} as const;
```

### Page Structure
[Source: docs/architecture/unified-project-structure.md]

**File to Create:**
```
app/
└── todos/
    ├── page.tsx           # Global todos page
    └── loading.tsx        # Loading skeleton
```

**Page Component Example (app/todos/page.tsx):**
```typescript
'use client';

import { useState } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import { TodoList } from '@/components/todos/todo-list';
import { TodoFilters } from '@/components/todos/todo-filters';
import { TodoForm } from '@/components/todos/todo-form';
import { SearchInput } from '@/components/shared/search-input';
import { Pagination } from '@/components/shared/pagination';
import { useTodos } from '@/lib/hooks/use-todos';
import { useUsers } from '@/lib/hooks/use-users';

export default function TodosPage() {
  const router = useRouter();
  const searchParams = useSearchParams();

  const status = searchParams.get('status') as 'all' | 'open' | 'completed' || 'all';
  const search = searchParams.get('q') || '';
  const page = parseInt(searchParams.get('page') || '1');

  const { data: todosData, isLoading } = useTodos({ status, search, page });
  const { data: users } = useUsers();

  const updateFilters = (updates: Record<string, string>) => {
    const params = new URLSearchParams(searchParams);
    Object.entries(updates).forEach(([key, value]) => {
      if (value) {
        params.set(key, value);
      } else {
        params.delete(key);
      }
    });
    router.push(`/todos?${params.toString()}`);
  };

  if (isLoading) {
    return <TodoListSkeleton />;
  }

  if (!todosData?.todos.length) {
    return <EmptyState />;
  }

  return (
    <div className="container mx-auto py-8">
      <h1 className="text-3xl font-bold mb-6">All Todos</h1>

      <div className="flex gap-4 mb-6">
        <TodoFilters
          value={status}
          onChange={(status) => updateFilters({ status, page: '1' })}
        />
        <SearchInput
          value={search}
          onChange={(q) => updateFilters({ q, page: '1' })}
          placeholder="Search todos..."
        />
      </div>

      <TodoForm />

      <TodoList
        todos={todosData.todos}
        users={users}
        showUserInfo
      />

      <Pagination
        currentPage={page}
        totalPages={todosData.pageCount}
        onPageChange={(page) => updateFilters({ page: page.toString() })}
      />
    </div>
  );
}
```

### UI Components
[Source: docs/architecture/components.md, docs/architecture/unified-project-structure.md]

**Components to Update/Create:**
- `components/todos/todo-list.tsx` - Update to support showUserInfo prop
- `components/todos/todo-item.tsx` - Add user avatar and link
- `components/todos/todo-filters.tsx` - Reuse from Story 4.3
- `components/todos/todo-form.tsx` - Reuse from Story 4.2
- `components/shared/search-input.tsx` - Create debounced search input
- `components/shared/pagination.tsx` - Reuse from posts

**shadcn/ui Components:**
- `Avatar` - For user avatars
- `Badge` - For completion status
- `Skeleton` - For loading states
- `Input` - For search input
- `Button` - For pagination controls
- `Card` - For todo items
- `Separator` - For visual separation

**TodoItem with User Info Example:**
```typescript
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Badge } from '@/components/ui/badge';
import { Checkbox } from '@/components/ui/checkbox';
import Link from 'next/link';
import type { Todo, User } from '@/types';

interface TodoItemProps {
  todo: Todo;
  user?: User;
  showUserInfo?: boolean;
}

export const TodoItem = ({ todo, user, showUserInfo }: TodoItemProps) => {
  return (
    <div className="flex items-center gap-3 p-3 border rounded-lg">
      <Checkbox checked={todo.completed} />

      <div className="flex-1">
        <p className={cn(
          "text-sm",
          todo.completed && "line-through text-muted-foreground"
        )}>
          {todo.title}
        </p>
      </div>

      {showUserInfo && user && (
        <Link
          href={`/users/${user.id}`}
          className="flex items-center gap-2 hover:underline"
        >
          <Avatar className="h-6 w-6">
            <AvatarFallback>{user.name[0]}</AvatarFallback>
          </Avatar>
          <span className="text-sm text-muted-foreground">{user.name}</span>
        </Link>
      )}

      {todo.completed && <Badge variant="secondary">Completed</Badge>}

      {/* Reassign dropdown */}
    </div>
  );
};
```

### Search Input Component
[Source: docs/architecture/components.md]

**Component to Create (components/shared/search-input.tsx):**
```typescript
'use client';

import { useState, useEffect } from 'react';
import { Input } from '@/components/ui/input';
import { Search } from 'lucide-react';

interface SearchInputProps {
  value: string;
  onChange: (value: string) => void;
  placeholder?: string;
  debounceMs?: number;
}

export const SearchInput = ({
  value,
  onChange,
  placeholder = 'Search...',
  debounceMs = 300,
}: SearchInputProps) => {
  const [localValue, setLocalValue] = useState(value);

  useEffect(() => {
    const timer = setTimeout(() => {
      onChange(localValue);
    }, debounceMs);

    return () => clearTimeout(timer);
  }, [localValue, debounceMs, onChange]);

  return (
    <div className="relative">
      <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
      <Input
        type="search"
        value={localValue}
        onChange={(e) => setLocalValue(e.target.value)}
        placeholder={placeholder}
        className="pl-10"
      />
    </div>
  );
};
```

### Pagination Pattern
[Source: docs/architecture/components.md]

**Reuse Pagination Component from Posts:**
- Located at `components/shared/pagination.tsx`
- Accepts currentPage, totalPages, onPageChange props
- Sync state with URL query parameter `?page=2`

**Pagination Logic:**
- 20 todos per page (configurable)
- Client-side pagination after filtering and search
- Update page in URL query params
- Reset to page 1 when filters or search change

### URL State Management
[Source: docs/architecture/frontend-architecture.md]

**Query Parameters:**
- `?status=completed` - Filter by completion status
- `?q=search+term` - Search query
- `?page=2` - Current page number

**Next.js Hooks:**
- `useSearchParams()` - Read current query params
- `useRouter()` - Update URL with new params
- Preserve existing params when updating

### Loading States
[Source: docs/architecture/coding-standards.md, docs/architecture/components.md]

**Loading Skeleton (app/todos/loading.tsx):**
```typescript
import { Skeleton } from '@/components/ui/skeleton';

export default function Loading() {
  return (
    <div className="container mx-auto py-8">
      <Skeleton className="h-10 w-64 mb-6" />

      <div className="flex gap-4 mb-6">
        <Skeleton className="h-10 w-40" />
        <Skeleton className="h-10 flex-1 max-w-md" />
      </div>

      <div className="space-y-3">
        {Array.from({ length: 20 }).map((_, i) => (
          <Skeleton key={i} className="h-16 w-full" />
        ))}
      </div>
    </div>
  );
}
```

### Empty State
[Source: docs/architecture/coding-standards.md]

**Empty State Component:**
```typescript
const EmptyState = () => (
  <div className="flex flex-col items-center justify-center py-12">
    <p className="text-muted-foreground text-lg">
      {search ? 'No todos match your search' : 'No todos found'}
    </p>
    <p className="text-sm text-muted-foreground mt-2">
      Try adjusting your filters or create a new todo
    </p>
  </div>
);
```

### Navigation Integration
[Source: docs/architecture/unified-project-structure.md]

**Update Navigation Component:**
- Add link to `/todos` route
- Label: "Todos" or "All Todos"
- Ensure active state styling for current route

### Accessibility Requirements
[Source: docs/architecture/coding-standards.md]

- Search input has proper label and placeholder
- Pagination controls keyboard navigable
- User links properly labeled for screen readers
- Loading states announced via aria-live regions
- Empty state clearly communicates no results

### Optimistic Updates Integration
[Source: docs/architecture/coding-standards.md, docs/architecture/frontend-architecture.md]

**Mutations Must Update Global Todos Cache:**
- Toggle completion (Story 4.1) - Update todo in global list
- Create todo (Story 4.2) - Add to global list
- Reassign todo (Story 4.4) - Update userId in global list

**Cache Update Pattern:**
```typescript
// In mutation onMutate
queryClient.setQueryData(queryKeys.todos.list({}), (old: Todo[]) => {
  return old.map(todo =>
    todo.id === todoId ? { ...todo, completed: !todo.completed } : todo
  );
});
```

### Component File Locations
[Source: docs/architecture/unified-project-structure.md]

```
app/
└── todos/
    ├── page.tsx           # Create: Global todos page
    └── loading.tsx        # Create: Loading skeleton

components/
├── todos/
│   ├── todo-item.tsx      # Update: Add user info support
│   ├── todo-list.tsx      # Update: Add showUserInfo prop
│   ├── todo-filters.tsx   # Reuse from Story 4.3
│   └── todo-form.tsx      # Reuse from Story 4.2
└── shared/
    ├── search-input.tsx   # Create: Debounced search
    └── pagination.tsx     # Reuse from posts

lib/
└── hooks/
    └── use-todos.ts       # Update: Add filters, search, pagination
```

### Testing
[Source: docs/architecture/testing-strategy.md]

**Unit Tests (tests/unit/components/todos/):**
- Test TodoList renders with user info
- Test search input debounces correctly
- Test filter controls update URL params
- Test pagination controls

**Integration Tests (tests/integration/):**
- Test complete global todos flow
- Test filtering updates displayed todos
- Test search filters todos by title
- Test pagination works correctly
- Test all mutations work in global view

**E2E Tests (tests/e2e/todos/):**
- Test navigate to /todos page
- Test filter todos by status
- Test search todos by title
- Test pagination between pages
- Test click user link navigates to profile
- Test toggle completion works
- Test reassign works
- Test create todo works
- Test loading and empty states
- Test accessibility (keyboard navigation, screen readers)

**E2E Test Example:**
```typescript
// tests/e2e/todos/global-todos.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Global Todos View', () => {
  test('displays all todos with user information', async ({ page }) => {
    await page.goto('/todos');

    // Wait for todos to load
    await expect(page.locator('h1:has-text("All Todos")')).toBeVisible();

    // Verify todos are displayed
    const todoItems = page.locator('[data-testid="todo-item"]');
    await expect(todoItems).toHaveCount(20); // First page

    // Verify user info is displayed
    const firstTodo = todoItems.first();
    await expect(firstTodo.locator('[data-testid="user-name"]')).toBeVisible();
    await expect(firstTodo.locator('[data-testid="user-avatar"]')).toBeVisible();
  });

  test('filters todos by status', async ({ page }) => {
    await page.goto('/todos');

    // Click "Completed" filter
    await page.click('text=Completed');

    // Verify URL updated
    await expect(page).toHaveURL(/status=completed/);

    // Verify only completed todos shown
    const todos = page.locator('[data-testid="todo-item"]');
    await expect(todos.locator('[data-testid="completion-badge"]')).toHaveCount(await todos.count());
  });

  test('searches todos by title', async ({ page }) => {
    await page.goto('/todos');

    // Type in search input
    await page.fill('input[placeholder*="Search"]', 'test');

    // Wait for debounce
    await page.waitForTimeout(400);

    // Verify URL updated
    await expect(page).toHaveURL(/q=test/);

    // Verify filtered results
    const todos = page.locator('[data-testid="todo-item"]');
    const count = await todos.count();
    expect(count).toBeLessThan(20); // Should be filtered
  });

  test('navigates between pages', async ({ page }) => {
    await page.goto('/todos');

    // Click next page
    await page.click('[aria-label="Next page"]');

    // Verify URL updated
    await expect(page).toHaveURL(/page=2/);

    // Verify different todos shown
    await expect(page.locator('[data-testid="todo-item"]')).toHaveCount(20);
  });

  test('user link navigates to profile', async ({ page }) => {
    await page.goto('/todos');

    // Click user link
    const firstUserLink = page.locator('[data-testid="user-link"]').first();
    const userName = await firstUserLink.textContent();
    await firstUserLink.click();

    // Verify navigation
    await expect(page).toHaveURL(/\/users\/\d+/);
    await expect(page.locator(`h1:has-text("${userName}")`)).toBeVisible();
  });
});
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_