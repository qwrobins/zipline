# Story 4.2: Create New Todo (Optimistic UI)

## Status
Approved

## Story
**As a** user,
**I want** to create new todos for users,
**so that** I can add tasks to any user's list.

## Acceptance Criteria
1. "Add Todo" button or form displayed on user profile Todos tab
2. Form includes: Todo title (required), User select dropdown (pre-filled with current profile user, but changeable)
3. Form validation using Zod schema (title required, min 3 characters)
4. Submitting form triggers optimistic insert: new todo immediately appears in list as incomplete
5. Success toast notification displayed ("Todo created!")
6. Form clears after successful submission
7. Mock POST request sent to `/todos` with form data
8. New todo assigned temporary ID and added to top of todos list
9. Todo count increments immediately
10. Error handling: if mock POST fails, remove optimistic todo and show error toast

## Tasks / Subtasks
- [ ] Create TodoForm component with form fields (AC: 1, 2)
  - [ ] Import shadcn/ui Button, Input, Select components
  - [ ] Add "Add Todo" button/trigger to show form
  - [ ] Create form with title input field
  - [ ] Create user select dropdown populated with users from useUsers hook
  - [ ] Pre-fill user select with current profile user
- [ ] Implement form validation with React Hook Form + Zod (AC: 3)
  - [ ] Create Zod schema: title required, min 3 characters
  - [ ] Integrate React Hook Form with Zod resolver
  - [ ] Display validation errors inline below fields
  - [ ] Disable submit button while form invalid
- [ ] Create useCreateTodo mutation hook (AC: 4, 7, 8, 10)
  - [ ] Create mutation function in lib/api/todos.ts for POST /todos
  - [ ] Implement React Query mutation with optimistic update
  - [ ] Generate temporary ID (negative number or UUID) in onMutate
  - [ ] Insert new todo at top of todos list in cache
  - [ ] Configure onError to remove optimistic todo from cache
  - [ ] Configure onSuccess to replace temporary ID with real ID
- [ ] Add success toast and form reset (AC: 5, 6)
  - [ ] Show success toast using Sonner on mutation success
  - [ ] Reset form fields after successful submission
  - [ ] Clear form errors after reset
- [ ] Update todo count summary to reflect new todo (AC: 9)
  - [ ] Todo count component auto-updates from cache
  - [ ] Increment count immediately on optimistic insert
- [ ] Integrate TodoForm into user profile Todos tab (AC: 1-10)
  - [ ] Add TodoForm above TodoList component
  - [ ] Pass current user ID as default to form
  - [ ] Verify form submission works in user profile context
  - [ ] Test error handling and rollback behavior

## Dev Notes

### Todo Data Model
[Source: docs/architecture/data-models.md]

The Todo interface for creating new todos:

```typescript
interface Todo {
  id: number;          // Generate temporary ID, replaced by API
  userId: number;      // From user select dropdown
  title: string;       // From form input
  completed: boolean;  // Always false for new todos
}
```

**Form Data Shape:**
```typescript
interface TodoFormData {
  title: string;
  userId: number;
}
```

### React Hook Form with Zod Validation
[Source: docs/architecture/tech-stack.md]

**Required Libraries:**
- React Hook Form 7.x: Form state management
- Zod 3.x: Runtime type validation

[Source: docs/architecture/coding-standards.md]

**Critical Rule:**
- **Form Validation:** Use React Hook Form + Zod for all forms; no uncontrolled inputs

**Implementation Pattern:**
```typescript
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';

const todoFormSchema = z.object({
  title: z.string().min(3, 'Title must be at least 3 characters'),
  userId: z.number(),
});

type TodoFormData = z.infer<typeof todoFormSchema>;

const form = useForm<TodoFormData>({
  resolver: zodResolver(todoFormSchema),
  defaultValues: {
    title: '',
    userId: currentUserId, // Pre-filled with profile user
  },
});
```

### React Query Mutation Pattern with Optimistic Updates
[Source: docs/architecture/components.md]

The mutation hook to implement:

```typescript
useCreateTodo(): Mutation hook with optimistic update
```

[Source: docs/architecture/frontend-architecture.md]

**Optimistic Update Pattern:**
- **Temporary IDs:** Client-generated IDs (negative numbers or UUIDs) for optimistic creates
- **Rollback on Failure:** Automatic cache rollback if API returns error
- **Query Key Hierarchy:** Use centralized queryKeys for cache invalidation

**Implementation Steps:**
1. **onMutate:** Generate temporary ID, insert todo into cache at top of list
2. **onError:** Remove optimistic todo from cache, show error toast
3. **onSuccess:** Replace temporary ID with real ID from API response
4. **onSettled:** Refetch or revalidate for consistency

**Query Keys:**
```typescript
export const queryKeys = {
  todos: {
    all: ['todos'] as const,
    lists: () => [...queryKeys.todos.all, 'list'] as const,
    list: (filters: TodoFilters) => [...queryKeys.todos.lists(), filters] as const,
  },
} as const;
```

### API Service Layer
[Source: docs/architecture/components.md]

API service function to implement in `lib/api/todos.ts`:

```typescript
createTodo(data: TodoFormData): Mock create todo
```

- Method: POST
- Endpoint: `/todos`
- Body: `{ title: string, userId: number }`
- Mock response: Return new todo object with generated ID

[Source: docs/architecture/frontend-architecture.md]

**API Client Pattern:**
```typescript
export async function createTodo(
  data: { title: string; userId: number }
): Promise<Todo> {
  return apiFetch('/todos', {
    method: 'POST',
    body: JSON.stringify(data),
  }, todoSchema);
}
```

- Must validate response with Zod schema
- JSONPlaceholder will return mock ID (may not persist)
- Client must handle temporary ID for optimistic UI

### Component Architecture
[Source: docs/architecture/frontend-architecture.md]

**Component Location:**
```
components/todos/
├── todo-form.tsx       # Form for creating todos (CREATE THIS)
├── todo-list.tsx       # List of todos (UPDATE THIS)
└── todo-item.tsx       # Individual todo item
```

**shadcn/ui Components to Use:**
- Button for submit and form trigger
- Input for title field
- Select for user dropdown
- Form components for layout and validation errors
- Optional: Dialog for modal form

### User Select Dropdown
[Source: docs/architecture/components.md]

**Required Hook:**
```typescript
useUsers(): Query hook for all users
```

- Fetch all users from `/users` endpoint
- Populate select dropdown with user names
- Store userId in form state
- Pre-fill with current profile user ID

**Select Component Pattern:**
```typescript
<Select
  value={field.value.toString()}
  onValueChange={(value) => field.onChange(parseInt(value))}
>
  <SelectTrigger>
    <SelectValue placeholder="Select user" />
  </SelectTrigger>
  <SelectContent>
    {users?.map((user) => (
      <SelectItem key={user.id} value={user.id.toString()}>
        {user.name}
      </SelectItem>
    ))}
  </SelectContent>
</Select>
```

### Temporary ID Generation
[Source: docs/architecture/frontend-architecture.md]

**Temporary ID Strategy:**
- Use negative numbers (e.g., `-Date.now()`) for client-generated IDs
- Alternative: Use UUID library for unique IDs
- Replace temporary ID with real ID from API in `onSuccess`

**Example:**
```typescript
const tempId = -Date.now(); // Negative number ensures no collision
const optimisticTodo: Todo = {
  id: tempId,
  userId: formData.userId,
  title: formData.title,
  completed: false,
};
```

### Error Handling and Toast Notifications
[Source: docs/architecture/coding-standards.md]

- **Error Handling:** Catch and display user-friendly errors; use toast notifications for feedback
- **Optimistic Updates:** All mutations must implement optimistic updates with rollback logic

[Source: docs/architecture/tech-stack.md]

**Notifications:** Sonner toast notification system

**Implementation:**
```typescript
import { toast } from 'sonner';

// Success notification
toast.success('Todo created!');

// Error notification
toast.error('Failed to create todo');
```

### Form Reset After Submission
[Source: AC 6]

After successful todo creation:
- Clear form fields using `form.reset()`
- Clear validation errors
- Optionally close dialog/modal if using one
- Keep user select at current profile user for convenience

**Example:**
```typescript
onSuccess: () => {
  toast.success('Todo created!');
  form.reset({
    title: '',
    userId: currentUserId, // Keep current user selected
  });
}
```

### Testing
[Source: docs/architecture/testing-strategy.md]

**Unit Tests Required:**
- `tests/unit/components/todos/todo-form.test.tsx`
  - Renders form with title input and user select
  - Shows validation error for empty title
  - Shows validation error for title less than 3 characters
  - Pre-fills user select with current profile user
  - Calls mutation handler on valid form submit

**Integration Tests Required:**
- `tests/integration/todo-management.test.tsx`
  - Creates new todo with optimistic UI
  - Verifies todo appears at top of list immediately
  - Verifies success toast shown
  - Verifies form resets after submission
  - Verifies optimistic todo removed on API failure

**E2E Tests Required:**
- `tests/e2e/todos/create-todo.spec.ts`
  - User can fill todo form and submit
  - New todo appears at top of list immediately
  - Success toast notification displayed
  - Form clears after successful submission
  - Todo count increments immediately
  - Error toast shown if creation fails

**MSW Mock Setup:**
```typescript
import { rest } from 'msw';
import { setupServer } from 'msw/node';

const server = setupServer(
  rest.post('https://jsonplaceholder.typicode.com/todos', async (req, res, ctx) => {
    const body = await req.json();
    return res(
      ctx.status(201),
      ctx.json({ id: 201, ...body, completed: false })
    );
  })
);
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_