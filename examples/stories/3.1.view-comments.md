# Story 3.1: View Comments on Post Detail

## Status
Approved

## Story
**As a** user,
**I want** to see all comments on a post in a clear, organized format,
**so that** I can read the discussion and understand different perspectives.

## Acceptance Criteria
1. Comments section rendered below post content on post detail page
2. Each comment displays: commenter name, email, timestamp (mock or post ID-based), and full comment body
3. Comments ordered chronologically (oldest first or newest first with toggle option)
4. Comment count badge shows accurate number (e.g., "23 Comments")
5. Empty state message displayed if no comments exist ("No comments yet. Be the first!")
6. Loading skeletons shown while comments are being fetched
7. Comments visually separated from post content (using Separator component or spacing)
8. Comments responsive on mobile devices with proper text wrapping

## Tasks / Subtasks
- [ ] Create Comment data model and types (AC: 2)
  - [ ] Define Comment TypeScript interface in /types/index.ts
  - [ ] Verify interface matches JSONPlaceholder API structure
- [ ] Create API service for fetching comments (AC: 1, 6)
  - [ ] Create /lib/api/comments.ts service file
  - [ ] Implement fetchComments(postId: number) function
  - [ ] Add Zod schema validation for Comment responses
  - [ ] Add error handling with APIError class
- [ ] Create React Query hook for comments (AC: 1, 6)
  - [ ] Create /lib/hooks/use-comments.ts
  - [ ] Implement useComments(postId: number) query hook
  - [ ] Configure query key using centralized queryKeys.comments.list pattern
  - [ ] Set appropriate staleTime and cacheTime
- [ ] Create CommentItem component (AC: 2, 8)
  - [ ] Create /components/comments/comment-item.tsx
  - [ ] Display commenter name, email, and body text
  - [ ] Add mock timestamp display (based on comment ID or post ID)
  - [ ] Ensure responsive design with proper text wrapping
  - [ ] Use Card component from shadcn/ui for layout
- [ ] Create CommentList component (AC: 1, 3, 4, 5, 7)
  - [ ] Create /components/comments/comment-list.tsx
  - [ ] Fetch comments using useComments hook
  - [ ] Display loading skeletons during fetch
  - [ ] Display empty state message when no comments exist
  - [ ] Implement comment count badge (e.g., "23 Comments")
  - [ ] Add Separator component between post and comments
  - [ ] Implement sort order toggle (optional: oldest/newest first)
  - [ ] Map comments to CommentItem components
- [ ] Integrate CommentList into post detail page (AC: 1, 7)
  - [ ] Update /app/posts/[id]/page.tsx to include CommentList
  - [ ] Ensure comments section positioned below post content
  - [ ] Add proper spacing and visual separation
- [ ] Add loading and error states (AC: 6)
  - [ ] Create comment skeleton components using Skeleton from shadcn/ui
  - [ ] Handle error states with error boundary or inline error message
  - [ ] Show toast notification on fetch errors

## Dev Notes

### Comment Data Model
[Source: docs/architecture/data-models.md]

**TypeScript Interface:**
```typescript
interface Comment {
  id: number;
  postId: number;
  name: string;
  email: string;
  body: string;
}
```

**Relationships:**
- Many-to-one with Post (comments.postId → posts.id)

**Key Attributes:**
- `id`: Unique comment identifier
- `postId`: Foreign key to parent post
- `name`: Commenter name (may differ from User.name)
- `email`: Commenter email
- `body`: Comment text content

### API Service Layer
[Source: docs/architecture/components.md]

**API Service Pattern:**
```typescript
// lib/api/comments.ts
import { apiFetch } from './client';
import { commentArraySchema } from './schemas';
import type { Comment } from '@/types';

export async function fetchComments(postId: number): Promise<Comment[]> {
  return apiFetch(`/posts/${postId}/comments`, undefined, commentArraySchema);
}
```

**Dependencies:** Native Fetch API, Zod schemas for validation
**Technology Stack:** TypeScript, Zod for runtime validation

### React Query Hook Pattern
[Source: docs/architecture/frontend-architecture.md]

**Query Keys Structure:**
```typescript
export const queryKeys = {
  comments: {
    all: ['comments'] as const,
    lists: () => [...queryKeys.comments.all, 'list'] as const,
    list: (postId: number) => [...queryKeys.comments.lists(), postId] as const,
  },
} as const;
```

**Hook Implementation:**
```typescript
// lib/hooks/use-comments.ts
import { useQuery } from '@tanstack/react-query';
import { fetchComments } from '@/lib/api/comments';
import { queryKeys } from '@/lib/api/query-keys';

export function useComments(postId: number) {
  return useQuery({
    queryKey: queryKeys.comments.list(postId),
    queryFn: () => fetchComments(postId),
    staleTime: 5 * 60 * 1000, // 5 minutes
    cacheTime: 10 * 60 * 1000, // 10 minutes
  });
}
```

**State Management Pattern:**
- Use React Query for ALL server state
- No Redux/Zustand needed for this feature
- Centralized query keys enable precise cache invalidation

### Component Structure
[Source: docs/architecture/unified-project-structure.md]

**Component Files:**
```
components/
└── comments/
    ├── comment-list.tsx      # List container with fetching logic
    ├── comment-item.tsx      # Individual comment display
    ├── comment-form.tsx      # Will be created in Story 3.2
    └── comment-actions.tsx   # Will be created in Story 3.3
```

### UI Components
[Source: docs/architecture/components.md]

**shadcn/ui Components to Use:**
- `Card`, `CardHeader`, `CardTitle`, `CardContent` for comment layout
- `Skeleton` for loading states
- `Separator` for visual separation from post content
- `Badge` for comment count display

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Critical Rules:**
- **Type Safety:** Enable TypeScript strict mode; no `any` types
- **API Response Validation:** All API responses must be validated with Zod schemas
- **Loading States:** Always show skeletons during data fetching; never blank screens
- **Error Handling:** Catch and display user-friendly errors
- **Component Composition:** Prefer composition over prop drilling

**Naming Conventions:**
- Components: PascalCase (`CommentList.tsx`, `CommentItem.tsx`)
- Hooks: camelCase with 'use' prefix (`useComments.ts`)
- Files: kebab-case (`comment-list.tsx`, `use-comments.ts`)

**Error Boundaries:**
- Wrap route segments with error.tsx for graceful error handling
- Consider inline error messages for comment fetch failures

### Component Template Example
[Source: docs/architecture/frontend-architecture.md]

```typescript
import { FC } from 'react';
import { Card, CardHeader, CardContent } from '@/components/ui/card';
import type { Comment } from '@/types';

interface CommentItemProps {
  comment: Comment;
}

export const CommentItem: FC<CommentItemProps> = ({ comment }) => {
  return (
    <Card>
      <CardHeader>
        <div className="flex flex-col gap-1">
          <span className="font-semibold">{comment.name}</span>
          <span className="text-sm text-muted-foreground">{comment.email}</span>
        </div>
      </CardHeader>
      <CardContent>
        <p className="text-sm">{comment.body}</p>
      </CardContent>
    </Card>
  );
};
```

### API Client Setup
[Source: docs/architecture/frontend-architecture.md]

**Base URL:** `https://jsonplaceholder.typicode.com`

**API Error Handling:**
```typescript
class APIError extends Error {
  constructor(
    message: string,
    public statusCode: number,
    public response?: unknown
  ) {
    super(message);
    this.name = 'APIError';
  }
}
```

### Zod Schema Validation
[Source: docs/architecture/tech-stack.md]

All API responses MUST be validated with Zod schemas:
```typescript
// lib/api/schemas.ts
import { z } from 'zod';

export const commentSchema = z.object({
  id: z.number(),
  postId: z.number(),
  name: z.string(),
  email: z.string().email(),
  body: z.string(),
});

export const commentArraySchema = z.array(commentSchema);
```

### Testing
[Source: docs/architecture/testing-strategy.md]

**Unit Tests Required:**
- `tests/unit/components/comments/comment-item.test.tsx`
  - Renders comment name, email, and body
  - Handles long text with proper wrapping
- `tests/unit/components/comments/comment-list.test.tsx`
  - Shows loading skeletons during fetch
  - Displays empty state when no comments
  - Renders comment count badge correctly
  - Maps comments to CommentItem components

**Integration Tests Required:**
- `tests/integration/comment-viewing.test.tsx`
  - Fetches and displays comments for a post
  - Handles API errors gracefully
  - Shows loading states correctly

**E2E Tests Required:**
- `tests/e2e/comments/view-comments.spec.ts`
  - Navigate to post detail page
  - Verify comments section rendered below post
  - Verify comment count badge displays correct number
  - Verify each comment shows name, email, and body
  - Verify empty state message when no comments
  - Verify responsive layout on mobile viewport

**Test Setup Pattern:**
```typescript
import { render, screen } from '@testing-library/react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { CommentList } from '@/components/comments/comment-list';

const createWrapper = () => {
  const queryClient = new QueryClient({
    defaultOptions: { queries: { retry: false } },
  });
  return ({ children }: { children: React.ReactNode }) => (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  );
};

describe('CommentList', () => {
  it('renders loading skeletons during fetch', () => {
    render(<CommentList postId={1} />, { wrapper: createWrapper() });
    expect(screen.getByTestId('comment-skeleton')).toBeInTheDocument();
  });
});
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_