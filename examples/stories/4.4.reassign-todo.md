# Story 4.4: Reassign Todo to Different User

## Status
Approved

## Story
**As a** user,
**I want** to reassign a todo to a different user,
**so that** I can move tasks to the appropriate person.

## Acceptance Criteria
1. Edit/reassign button displayed on each todo item (dropdown menu or inline action)
2. Clicking reassign opens dropdown or dialog with user select dropdown
3. User dropdown populated with all users from `/users` endpoint
4. Selecting new user triggers optimistic update: todo disappears from current user's list (if viewing profile)
5. Success toast notification displayed ("Todo reassigned to [Username]!")
6. Mock PATCH request sent to `/todos/{id}` with updated `userId`
7. Error handling: if mock PATCH fails, restore todo to original user and show error toast
8. Todo counts update appropriately on both users' profiles
9. If viewing global todos, reassigned todo updates user label immediately

## Tasks / Subtasks
- [ ] Add reassign button/action to TodoItem component (AC: 1)
  - [ ] Add dropdown menu or inline edit icon to todo-item.tsx
  - [ ] Use shadcn/ui Select or DropdownMenu component
  - [ ] Ensure button is keyboard accessible and properly labeled
- [ ] Implement user select dropdown (AC: 2, 3)
  - [ ] Create or update reassign UI with user select dropdown
  - [ ] Use useUsers() hook to fetch all users
  - [ ] Populate dropdown with user names and IDs
  - [ ] Display loading state while users are fetching
- [ ] Create useReassignTodo mutation hook (AC: 4, 6, 7)
  - [ ] Add updateTodo API function in lib/api/todos.ts for PATCH `/todos/{id}`
  - [ ] Create useReassignTodo hook in lib/hooks/use-todos.ts
  - [ ] Implement optimistic update logic:
    - [ ] Save previous todo state for rollback
    - [ ] Update cache immediately with new userId
    - [ ] Remove from current user's list if viewing profile
    - [ ] Update global todos cache if applicable
  - [ ] Handle error with rollback and toast notification
- [ ] Update TodoItem component with reassign functionality (AC: 4, 5, 9)
  - [ ] Connect reassign action to useReassignTodo mutation
  - [ ] Handle optimistic UI updates (todo disappears from user profile view)
  - [ ] Display success toast with new user's name
  - [ ] Update user label in global todos view
- [ ] Update todo counts across views (AC: 8)
  - [ ] Decrement count for original user in cache
  - [ ] Increment count for new user in cache
  - [ ] Update UserProfile component to reflect new counts
- [ ] Add error handling and rollback (AC: 7)
  - [ ] Implement onError callback in mutation
  - [ ] Restore original todo with original userId
  - [ ] Display error toast with clear message
- [ ] Test reassign functionality
  - [ ] Test from user profile Todos tab
  - [ ] Test from global todos view
  - [ ] Test error scenarios and rollback
  - [ ] Test todo count updates
  - [ ] Test accessibility (keyboard navigation, screen readers)

## Dev Notes

### Data Models
[Source: docs/architecture/data-models.md]

**Todo Interface:**
```typescript
interface Todo {
  id: number;
  userId: number;
  title: string;
  completed: boolean;
}
```

**User Interface:**
```typescript
interface User {
  id: number;
  name: string;
  username: string;
  email: string;
  address: {
    street: string;
    suite: string;
    city: string;
    zipcode: string;
    geo: {
      lat: string;
      lng: string;
    };
  };
  phone: string;
  website: string;
  company: {
    name: string;
    catchPhrase: string;
    bs: string;
  };
}
```

**Relationships:**
- Many-to-one: Todo.userId → User.id

### API Service Layer
[Source: docs/architecture/components.md, docs/architecture/frontend-architecture.md]

**API Function to Add (lib/api/todos.ts):**
```typescript
export async function updateTodo(
  id: number,
  data: Partial<Todo>
): Promise<Todo> {
  return apiFetch(`/todos/${id}`, {
    method: 'PATCH',
    body: JSON.stringify(data),
  });
}
```

**Mock PATCH Request:**
- Endpoint: `PATCH /todos/{id}`
- Request body: `{ userId: number }`
- Response: Updated Todo object

### React Query Mutation Hook
[Source: docs/architecture/components.md, docs/architecture/frontend-architecture.md]

**Hook to Create (lib/hooks/use-todos.ts):**
```typescript
export function useReassignTodo() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ todoId, newUserId }: { todoId: number; newUserId: number }) =>
      updateTodo(todoId, { userId: newUserId }),

    onMutate: async ({ todoId, newUserId }) => {
      // Cancel outgoing refetches
      await queryClient.cancelQueries({ queryKey: queryKeys.todos.all });

      // Snapshot previous values
      const previousTodos = queryClient.getQueryData(queryKeys.todos.lists());
      const previousUserTodos = queryClient.getQueryData(
        queryKeys.todos.list({ userId: oldUserId })
      );

      // Optimistically update cache
      queryClient.setQueryData(queryKeys.todos.lists(), (old: Todo[]) => {
        return old.map(todo =>
          todo.id === todoId ? { ...todo, userId: newUserId } : todo
        );
      });

      // Remove from old user's list
      queryClient.setQueryData(
        queryKeys.todos.list({ userId: oldUserId }),
        (old: Todo[]) => old.filter(todo => todo.id !== todoId)
      );

      // Add to new user's list
      queryClient.setQueryData(
        queryKeys.todos.list({ userId: newUserId }),
        (old: Todo[]) => [...old, updatedTodo]
      );

      return { previousTodos, previousUserTodos };
    },

    onError: (err, variables, context) => {
      // Rollback on error
      if (context?.previousTodos) {
        queryClient.setQueryData(queryKeys.todos.lists(), context.previousTodos);
      }
      if (context?.previousUserTodos) {
        queryClient.setQueryData(
          queryKeys.todos.list({ userId: oldUserId }),
          context.previousUserTodos
        );
      }
      toast.error('Failed to reassign todo');
    },

    onSuccess: (data, variables) => {
      // Get new user name for success message
      const user = queryClient.getQueryData(queryKeys.users.detail(variables.newUserId));
      toast.success(`Todo reassigned to ${user?.name || 'user'}!`);
    },

    onSettled: () => {
      // Refetch to ensure consistency
      queryClient.invalidateQueries({ queryKey: queryKeys.todos.all });
    },
  });
}
```

### Query Keys
[Source: docs/architecture/frontend-architecture.md]

**Centralized Query Keys:**
```typescript
export const queryKeys = {
  todos: {
    all: ['todos'] as const,
    lists: () => [...queryKeys.todos.all, 'list'] as const,
    list: (filters: TodoFilters) => [...queryKeys.todos.lists(), filters] as const,
  },
  users: {
    all: ['users'] as const,
    lists: () => [...queryKeys.users.all, 'list'] as const,
    list: () => [...queryKeys.users.lists()] as const,
    details: () => [...queryKeys.users.all, 'detail'] as const,
    detail: (id: number) => [...queryKeys.users.details(), id] as const,
  },
} as const;
```

### UI Components
[Source: docs/architecture/components.md, docs/architecture/unified-project-structure.md]

**Components to Update:**
- `components/todos/todo-item.tsx` - Add reassign button and dropdown
- `components/todos/todo-list.tsx` - May need updates for count display

**shadcn/ui Components to Use:**
- `Select` - For user dropdown
- `DropdownMenu` - For action menu (optional, could use inline select)
- `Button` - For reassign trigger
- `Dialog` - Optional, if using modal instead of dropdown

**Component Structure Example (TodoItem):**
```typescript
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { useUsers } from '@/lib/hooks/use-users';
import { useReassignTodo } from '@/lib/hooks/use-todos';

export const TodoItem = ({ todo }: { todo: Todo }) => {
  const { data: users } = useUsers();
  const reassignMutation = useReassignTodo();

  const handleReassign = (newUserId: string) => {
    reassignMutation.mutate({
      todoId: todo.id,
      newUserId: parseInt(newUserId),
    });
  };

  return (
    <div className="flex items-center gap-2">
      {/* Checkbox and title */}

      <Select onValueChange={handleReassign} defaultValue={todo.userId.toString()}>
        <SelectTrigger className="w-[180px]">
          <SelectValue placeholder="Reassign to..." />
        </SelectTrigger>
        <SelectContent>
          {users?.map(user => (
            <SelectItem key={user.id} value={user.id.toString()}>
              {user.name}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>
    </div>
  );
};
```

### Optimistic Updates Pattern
[Source: docs/architecture/coding-standards.md, docs/architecture/frontend-architecture.md]

**Key Requirements:**
- Immutable cache updates using setQueryData
- Save previous state in onMutate for rollback
- Update multiple query keys (global todos, user-filtered todos, counts)
- Rollback in onError callback
- Invalidate queries in onSettled for consistency

**State Management:**
- Use React Query for all server state
- No local state needed for reassign operation
- Cache updates must be immutable (spread operators, .map(), .filter())

### Toast Notifications
[Source: docs/architecture/tech-stack.md]

**Sonner Toast Library:**
```typescript
import { toast } from 'sonner';

// Success
toast.success('Todo reassigned to [Username]!');

// Error
toast.error('Failed to reassign todo. Please try again.');
```

### Accessibility Requirements
[Source: docs/architecture/coding-standards.md]

- Select dropdown must be keyboard navigable
- Reassign button must have proper ARIA label
- Success/error messages announced to screen readers via toast
- Focus management after reassign action

### Component File Locations
[Source: docs/architecture/unified-project-structure.md]

```
components/
├── todos/
│   ├── todo-item.tsx      # Update with reassign functionality
│   ├── todo-list.tsx      # May need count updates
│   └── todo-form.tsx
lib/
├── api/
│   └── todos.ts           # Add updateTodo function
└── hooks/
    └── use-todos.ts       # Add useReassignTodo hook
```

### Testing
[Source: docs/architecture/testing-strategy.md]

**Unit Tests (tests/unit/components/todos/):**
- Test TodoItem reassign button renders
- Test user dropdown populates with users
- Test optimistic update fires on selection
- Test error state displays toast

**Integration Tests (tests/integration/):**
- Test complete reassign flow with mock API
- Test todo disappears from user profile
- Test todo appears with new user in global view
- Test count updates on both users

**E2E Tests (tests/e2e/todos/):**
- Test reassign from user profile (reassign-todo.spec.ts)
- Test reassign from global todos view
- Test error handling and rollback
- Test success toast displays with correct username
- Test keyboard navigation for accessibility

**Test Patterns:**
```typescript
// Integration test example
describe('Todo Reassignment', () => {
  it('reassigns todo with optimistic update', async () => {
    const user = userEvent.setup();
    render(<TodoList userId={1} />);

    // Wait for todos to load
    await screen.findByText('Test Todo');

    // Open reassign dropdown
    const select = screen.getByRole('combobox');
    await user.click(select);

    // Select new user
    await user.click(screen.getByText('Jane Doe'));

    // Verify optimistic update (todo disappears from list)
    await waitFor(() => {
      expect(screen.queryByText('Test Todo')).not.toBeInTheDocument();
    });

    // Verify success toast
    expect(screen.getByText(/reassigned to Jane Doe/i)).toBeInTheDocument();
  });
});
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_