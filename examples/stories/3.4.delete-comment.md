# Story 3.4: Delete Comment (Optimistic UI with Undo)

## Status
Approved

## Story
**As a** user,
**I want** to delete my comment,
**so that** I can remove content I no longer want visible.

## Acceptance Criteria
1. Delete button (icon or text) displayed on each comment (in dropdown menu or inline)
2. Clicking delete triggers immediate optimistic removal: comment disappears from list
3. Toast notification displayed with undo option ("Comment deleted. Undo?")
4. Comment count badge decrements immediately
5. Mock DELETE request sent to `/comments/{id}`
6. Undo button in toast restores comment to list and cancels DELETE request
7. Toast auto-dismisses after 5 seconds if no undo action taken
8. Error handling: if mock DELETE fails and user didn't undo, restore comment and show error toast
9. Confirmation dialog optional (consider for better UX, but optimistic + undo may be sufficient)

## Tasks / Subtasks
- [ ] Add delete button to comment actions (AC: 1)
  - [ ] Add delete icon to CommentActions component (Trash2 from lucide-react)
  - [ ] Include delete button in dropdown menu or inline actions
  - [ ] Add proper ARIA labels for accessibility
  - [ ] Style with hover states using shadcn/ui button variants
- [ ] Implement useDeleteComment mutation hook (AC: 2, 5)
  - [ ] Create mutation hook in lib/hooks/use-comments.ts
  - [ ] Configure optimistic update to remove comment from cache immediately
  - [ ] Call DELETE API endpoint: `/comments/{id}`
  - [ ] Update comment count in post query cache
  - [ ] Store snapshot of previous data for rollback
- [ ] Implement Sonner toast with undo functionality (AC: 3, 6, 7)
  - [ ] Display toast with undo action button using Sonner
  - [ ] Set toast duration to 5000ms (5 seconds)
  - [ ] Implement undo handler to restore comment from snapshot
  - [ ] Cancel pending DELETE request if undo is clicked
  - [ ] Restore comment count badge on undo
- [ ] Update comment count badge (AC: 4)
  - [ ] Decrement comment count in optimistic update
  - [ ] Increment comment count on undo
  - [ ] Ensure post detail page badge updates
  - [ ] Ensure post card badge updates on feed
- [ ] Implement error handling with rollback (AC: 8)
  - [ ] Catch API errors in onError callback
  - [ ] Restore comment from snapshot if error occurs
  - [ ] Display error toast with user-friendly message
  - [ ] Restore comment count to previous value
  - [ ] Log error to console for debugging
- [ ] Add loading/submitting state (AC: 2)
  - [ ] Show loading indicator on delete button during mutation
  - [ ] Disable delete button while mutation is pending
  - [ ] Handle race conditions with multiple delete actions
- [ ] Evaluate confirmation dialog option (AC: 9)
  - [ ] Consider UX tradeoff: optimistic + undo vs confirmation
  - [ ] Document decision in dev notes
  - [ ] Optionally implement AlertDialog if deemed necessary

## Dev Notes

### Comment Data Model
[Source: docs/architecture/data-models.md]

The Comment interface structure:
```typescript
interface Comment {
  id: number;
  postId: number;
  name: string;
  email: string;
  body: string;
}
```

The comment will be removed from the cache immediately when deleted, with all fields available in the snapshot for undo functionality.

### React Query Mutation Pattern
[Source: docs/architecture/frontend-architecture.md]

Query key structure for comments:
```typescript
queryKeys.comments = {
  all: ['comments'] as const,
  lists: () => [...queryKeys.comments.all, 'list'] as const,
  list: (postId: number) => [...queryKeys.comments.lists(), postId] as const,
}
```

### API Service Layer
[Source: docs/architecture/components.md]

Delete comment API function signature:
```typescript
deleteComment(id: number): Promise<void>
```

Mock DELETE request to JSONPlaceholder endpoint: `/comments/{id}`

### Optimistic Update with Undo Pattern
[Source: docs/architecture/coding-standards.md]

The mutation MUST implement:
1. Optimistic removal from cache before API call
2. Snapshot of previous data for rollback
3. onMutate callback to update cache immediately
4. onError callback to restore from snapshot
5. onSettled callback to refetch/invalidate queries

Example pattern:
```typescript
export function useDeleteComment() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (commentId: number) => deleteComment(commentId),

    onMutate: async (commentId) => {
      // Cancel outgoing refetches
      await queryClient.cancelQueries({ queryKey: queryKeys.comments.all });

      // Snapshot previous value
      const previousComments = queryClient.getQueryData(
        queryKeys.comments.list(postId)
      );

      // Optimistically remove comment
      queryClient.setQueryData(
        queryKeys.comments.list(postId),
        (old: Comment[] | undefined) =>
          old?.filter(comment => comment.id !== commentId) ?? []
      );

      // Decrement comment count
      // ... update post query cache

      return { previousComments, commentId };
    },

    onError: (err, commentId, context) => {
      // Rollback to previous state
      if (context?.previousComments) {
        queryClient.setQueryData(
          queryKeys.comments.list(postId),
          context.previousComments
        );
      }

      toast.error('Failed to delete comment');
    },

    onSettled: () => {
      queryClient.invalidateQueries({ queryKey: queryKeys.comments.all });
    },
  });
}
```

### Sonner Toast with Undo
[Source: docs/architecture/tech-stack.md]

Use Sonner for toast notifications with undo action:
```typescript
import { toast } from 'sonner';

const handleDelete = () => {
  let isUndone = false;

  const toastId = toast('Comment deleted', {
    duration: 5000,
    action: {
      label: 'Undo',
      onClick: () => {
        isUndone = true;
        // Restore comment logic
      },
    },
  });

  // Proceed with delete mutation
  deleteMutation.mutate(commentId, {
    onSuccess: () => {
      if (isUndone) {
        // Cancel or rollback deletion
      }
    },
  });
};
```

### Accessibility Requirements
[Source: docs/architecture/coding-standards.md]

- Delete button MUST have proper ARIA label
- Toast notifications MUST be announced to screen readers
- Keyboard navigation MUST support delete action
- Undo button MUST be keyboard accessible

### Component Organization
[Source: docs/architecture/unified-project-structure.md]

Files to modify/create:
- `components/comments/comment-actions.tsx` - Add delete button
- `lib/hooks/use-comments.ts` - Add useDeleteComment hook
- `lib/api/comments.ts` - Add deleteComment service function
- `components/comments/comment-item.tsx` - Integrate delete action

### Error Handling
[Source: docs/architecture/coding-standards.md]

All errors MUST:
- Be caught and logged to console
- Display user-friendly error messages via toast
- Trigger rollback of optimistic updates
- Not crash the application

### Testing
[Source: docs/architecture/testing-strategy.md]

**Unit Tests Required:**
- Test useDeleteComment mutation hook
- Test optimistic update logic
- Test rollback on error
- Test undo functionality

**Integration Tests Required:**
- Test delete flow with API mock
- Test undo flow with toast interaction
- Test error handling with failed API call
- Test comment count updates

**E2E Tests Required:**
```typescript
// tests/e2e/comments/delete-comment.spec.ts
test('user can delete a comment with undo option', async ({ page }) => {
  await page.goto('/posts/1');

  // Click delete button on first comment
  await page.click('[data-testid="comment-item"]:first-child [aria-label="Delete comment"]');

  // Verify optimistic removal
  await expect(page.locator('[data-testid="comment-item"]')).toHaveCount(n - 1);

  // Verify toast with undo
  await expect(page.locator('text=Comment deleted')).toBeVisible();
  await expect(page.locator('button:has-text("Undo")')).toBeVisible();

  // Verify comment count decremented
  await expect(page.locator('[data-testid="comment-count"]')).toHaveText('n-1');
});

test('undo restores deleted comment', async ({ page }) => {
  await page.goto('/posts/1');

  const initialCount = await page.locator('[data-testid="comment-item"]').count();

  // Delete comment
  await page.click('[data-testid="comment-item"]:first-child [aria-label="Delete comment"]');

  // Click undo
  await page.click('button:has-text("Undo")');

  // Verify comment restored
  await expect(page.locator('[data-testid="comment-item"]')).toHaveCount(initialCount);
});
```

### Query Cache Invalidation
[Source: docs/architecture/frontend-architecture.md]

After successful deletion (if not undone):
```typescript
queryClient.invalidateQueries({ queryKey: queryKeys.comments.list(postId) });
queryClient.invalidateQueries({ queryKey: queryKeys.posts.detail(postId) });
```

### Styling
Use shadcn/ui components:
- Button component for delete action (destructive variant)
- DropdownMenu for action menu
- Sonner toast for notifications

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_